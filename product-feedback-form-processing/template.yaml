AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Serverless product feedback form handler - it accepts a form submission from a webpage and starts a state machine (workflow), which:
  1) does an sentiment analysis by using Amazon Comprehend
  2) saves the feedback data and the sentiment analysis in an Amazon DynamoDB table
  3) in case it's a negative feedback, it generates a case and
  4) notifies an agent to follow up with it

##########################################################################
#  Parameters & Globals                                                  #
##########################################################################
Parameters:
  VerifiedEmail:
    Type: String
    Description: (Required) A validated SES email address for receiving new submissions.
    MaxLength: 70
    MinLength: 4
    ConstraintDescription: Required. Must be a SES verified email address.

Resources:
##########################################################################
#  Dynamo DB Table                                                      #
##########################################################################
  FormDataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: formId
        AttributeType: S
      KeySchema:
      - AttributeName: formId
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST

##########################################################################
#  Lambda functions                                                      #
##########################################################################
  CreateCase:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: functions/create-case/
      Timeout: 5
      AutoPublishAlias: live
      Handler: app.lambda_handler
      Runtime: python3.9
      MemorySize: 128
      Tracing: Active

##########################################################################
#   CLOUD WATCH LOGS                                                     #
##########################################################################
  ProductFeedbackFormStateMachineCloudWatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /product-feedback-form-processing/step-functions
      RetentionInDays: 7

  RestApiforSyncWFCloudWatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /product-feedback-form-processing/api-gateway-access
      RetentionInDays: 7

##########################################################################
#   STEP FUNCTION                                                        #
##########################################################################
  ProductFeedbackFormStateMachineExpressSync:
    Type: AWS::Serverless::StateMachine # More info about State Machine Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-statemachine.html
    Properties:
      Type: EXPRESS
      DefinitionUri: statemachine/sfn-template.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt ProductFeedbackFormStateMachineCloudWatchLogsGroup.Arn
        IncludeExecutionData: True
        Level: ALL # ALL | ERROR | FATAL | OFF
      Tracing:
        Enabled: true
      DefinitionSubstitutions:
        CreateCase: !Ref CreateCase
        DDBTable: !Ref FormDataTable
        SourceEmail: !Ref VerifiedEmail
      Policies: # Find out more about SAM policy templates: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-policy-templates.html
        - ComprehendBasicAccessPolicy: {}
        - LambdaInvokePolicy:
            FunctionName: !Ref CreateCase
        - DynamoDBWritePolicy:
            TableName: !Ref FormDataTable
        - SESCrudPolicy:
            IdentityName: !Ref VerifiedEmail
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: # see https://docs.aws.amazon.com/step-functions/latest/dg/cw-logs.html
                - logs:CreateLogStream
                - logs:GetLogDelivery
                - logs:UpdateLogDelivery
                - logs:DeleteLogDelivery
                - logs:ListLogDeliveries
                - logs:PutResourcePolicy
                - logs:DescribeResourcePolicies
                - logs:DescribeLogGroups
                - logs:PutLogEvents
              Resource: "*"

##########################################################################
#   REST API                                                             #
##########################################################################
  RestApiforSyncWF:
    Type: AWS::Serverless::Api
    Properties:
      StageName: live
      EndpointConfiguration:
        Type: REGIONAL
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: "/*" # allows for logging on any resource
          HttpMethod: "*" # allows for logging on any method
      AccessLogSetting:
        DestinationArn: !GetAtt RestApiforSyncWFCloudWatchLogsGroup.Arn
        Format: "$context.identity.sourceIp $context.identity.caller $context.identity.user [$context.requestTime] $context.httpMethod $context.resourcePath $context.protocol $context.status $context.responseLength $context.requestId"
      TracingEnabled: True
      DefinitionBody:
        'Fn::Transform':
          Name: 'AWS::Include'
          Parameters:
            Location: 'api/api.yaml'

##########################################################################
#   Roles                                                               #
##########################################################################
  RestApiRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - apigateway.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Policies:
      - PolicyName: AllowSFNExec
        PolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: "states:StartSyncExecution"
              Resource: !GetAtt ProductFeedbackFormStateMachineExpressSync.Arn
      - PolicyName: AllowCWLogging
        PolicyDocument:
          Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:DescribeLogGroups
                - logs:DescribeLogStreams
                - logs:PutLogEvents
                - logs:GetLogEvents
                - logs:FilterLogEvents
              Resource: "*"

##########################################################################
#   Outputs                                                              #
##########################################################################
Outputs:
  CreateCase:
    Description: "Lambda Function ARN"
    Value: !GetAtt CreateCase.Arn
  FormDataTable:
    Description: DynamoDB Table
    Value: !Ref FormDataTable
  RestApiEndpoint:
    Description: "Sync StepFunctions Express API endpoint"
    Value: !Sub "https://${RestApiforSyncWF}.execute-api.${AWS::Region}.amazonaws.com/live/"
  StepFunctionsArn:
    Description: "Step Functions"
    Value: !GetAtt ProductFeedbackFormStateMachineExpressSync.Arn