AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  ...:
  1) ...
  2) ...
  3) ...
  4) ...

##########################################################################
#  Parameters & Globals                                                  #
##########################################################################
Parameters:
  TargetLanguage :
    Type: String
    Default: 'en'
  VerifiedEmail:
    Type: String
    Description: (Required) A validated SES email address for receiving new submissions.
    MaxLength: 70
    MinLength: 4
    ConstraintDescription: Required. Must be an Amazon SES verified email address.


Resources:
  SolutionTranslationS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete

  SolutionLanguageDetectionAndTranslationStateMachineCloudWatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /solution-language-detection-and-translation/step-functions
      RetentionInDays: 7

  SolutionLanguageDetectionAndTranslationStateMachine:
    Type: AWS::Serverless::StateMachine # More info about State Machine Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-statemachine.html
    Properties:
      Name: SolutionLanguageDetectionAndTranslationStateMachine
      Type: STANDARD
      DefinitionUri: statemachine/solution-sfn-template.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SolutionLanguageDetectionAndTranslationStateMachineCloudWatchLogsGroup.Arn
        IncludeExecutionData: True
        Level: ALL # ALL | ERROR | FATAL | OFF
      Tracing:
        Enabled: true
      DefinitionSubstitutions:
        TargetLanguage: !Ref TargetLanguage
        TranslationS3Bucket: !Ref SolutionTranslationS3Bucket
        SourceEmail: !Ref VerifiedEmail
        APIEndpoint: !Sub "https://${SolutionRestApi}.execute-api.${AWS::Region}.amazonaws.com/live"
      Policies: # Find out more about SAM policy templates: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-policy-templates.html
        - ComprehendBasicAccessPolicy: {}
        - SESCrudPolicy:
            IdentityName: !Ref VerifiedEmail
        - S3CrudPolicy:
            BucketName: !Ref SolutionTranslationS3Bucket
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - translate:translateText
              Resource: "*"
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: # see https://docs.aws.amazon.com/step-functions/latest/dg/cw-logs.html
                - logs:CreateLogDelivery
                - logs:GetLogDelivery
                - logs:UpdateLogDelivery
                - logs:DeleteLogDelivery
                - logs:ListLogDeliveries
                - logs:PutResourcePolicy
                - logs:DescribeResourcePolicies
                - logs:DescribeLogGroups
              Resource: "*"

  SolutionRestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: live
      EndpointConfiguration:
        Type: REGIONAL
      TracingEnabled: True
      DefinitionBody:
        'Fn::Transform':
          Name: 'AWS::Include'
          Parameters:
            Location: 'api/solution-api.yaml'

  SolutionRestApiRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - apigateway.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: AllowSFNStartListExecution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                  - states:ListExecutions
                  - states:SendTaskSuccess
                  - states:SendTaskFailure
                Resource: !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:SolutionLanguageDetectionAndTranslationStateMachine"
        - PolicyName: AllowSFNStopDescribeExecution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - states:DescribeExecution
                  - states:StopExecution
                Resource: !Sub "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:SolutionLanguageDetectionAndTranslationStateMachine:*"

##########################################################################
#   Outputs                                                              #
##########################################################################
#Outputs:
